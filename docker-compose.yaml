networks:
  dockernet:
    name: dockernet
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/24
          gateway: 172.18.0.1

services:
  # Proxy from host to service (SSL frontend)
  haproxy:
    image: haproxy:3.0.12-alpine
    container_name: haproxy
    user: haproxy
    restart: unless-stopped
    volumes:
      - ./_configs/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
      - ./_configs/ssl.pem:/usr/local/etc/haproxy/ssl.pem
      - ./_configs/container_hosts:/etc/hosts
    networks:
      dockernet:
        ipv4_address: 172.18.0.2
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
      - "1024:1024" # Stats page

  # Basic web page
  ubuntu:
    image: ubuntu:latest
    container_name: ubunutu-localhost
    restart: unless-stopped
    volumes:
      - ./application/redis/insight:/data
      - ./_configs/ubuntu-init.sh:/init.sh
    networks:
      dockernet:
        ipv4_address: 172.18.0.3
    command: /bin/bash -c /init.sh

  #
  # Web Admin Panels
  #

  redisinsight:
    image: redis/redisinsight:2.70.1
    container_name: redis-insight
    restart: unless-stopped
    volumes:
      - ./application/redis/insight:/data
      - ./_configs/container_hosts:/etc/hosts
    environment:
      RI_REDIS_HOST: redis
      RI_REDIS_PORT: 6379
      RI_REDIS_USERNAME: default
    networks:
      dockernet:
        ipv4_address: 172.18.0.10

  adminer:
    image: adminer:5.4.1-standalone
    container_name: database-adminer
    restart: unless-stopped
    volumes:
      - ./application/adminer:/data
      - ./_configs/container_hosts:/etc/hosts
    networks:
      dockernet:
        ipv4_address: 172.18.0.11

  pgadmin:
    image: dpage/pgadmin4:9.10.0
    container_name: postgres-pgadmin
    restart: unless-stopped
    volumes:
      - ./application/postgres/pgadmin:/var/lib/pgadmin
      - ./_configs/pgadmin_servers.json:/pgadmin4/servers.json
      - ./_configs/container_hosts:/etc/hosts
    environment:
      PGADMIN_CONFIG_GLOBALLY_DELIVERABLE: "False"
      PGADMIN_CONFIG_ALLOW_SPECIAL_EMAIL_DOMAINS: '["local"]'
      PGADMIN_CONFIG_CHECK_EMAIL_DELIVERABILITY: "False"
      PGADMIN_LISTEN_ADDRESS: 0.0.0.0
      PGADMIN_LISTEN_PORT: 80
      PGADMIN_DEFAULT_EMAIL: ${DEFAULT_USERNAME}@local
      PGADMIN_DEFAULT_PASSWORD: ${DEFAULT_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: "True"
    networks:
      dockernet:
        ipv4_address: 172.18.0.12

  phpmyadmin:
    image: phpmyadmin:5.2.3
    container_name: mariadb-phpmyadmin
    restart: unless-stopped
    volumes:
      - ./_configs/container_hosts:/etc/hosts
    environment:
      PMA_ARBITRARY: 1
    networks:
      dockernet:
        ipv4_address: 172.18.0.13

  milvusadmin:
    image: zilliz/attu:v2.6.2
    container_name: milvus-attu-admin
    restart: unless-stopped
    volumes:
      - ./_configs/container_hosts:/etc/hosts
    environment:
      MILVUS_URL: milvus:19530
    networks:
      dockernet:
        ipv4_address: 172.18.0.14

  #
  # Workflow Services
  #

  n8n:
    image: n8nio/n8n:1.123.3
    container_name: Workflow-n8n
    restart: unless-stopped
    volumes:
      - ./application/n8n:/home/node/.n8n
      - ./n8n-workflow:/workflow
      - ./_configs/ssl.crt:/home/node/ssl.crt
      - ./_configs/ssl.key:/home/node/ssl.key
      - ./_configs/ssl.key:/home/node/ssl.key
      - ./_configs/container_hosts:/etc/hosts
    environment:
      GENERIC_TIMEZONE: America/Vancouver
      TZ: America/Vancouver
      N8N_PROTOCOL: https
      N8N_HOST: n8n.local
      N8N_LISTEN_ADDRESS: 0.0.0.0
      N8N_PORT: 443
      N8N_SSL_CERT: /home/node/ssl.crt
      N8N_SSL_KEY: /home/node/ssl.key
      N8N_RUNNERS_ENABLED: true
      N8N_BLOCK_ENV_ACCESS_IN_NODE: false
      N8N_GIT_NODE_DISABLE_BARE_REPOS: true
      DB_TYPE: sqlite
      DB_SQLITE_POOL_SIZE: 1
      DB_SQLITE_VACUUM_ON_STARTUP: true
    networks:
      dockernet:
        ipv4_address: 172.18.0.20

  #
  # Database Services
  #

  redis:
    image: redis:7.2
    container_name: redis
    restart: unless-stopped
    volumes:
      - ./application/redis/db:/data
      - ./_configs/container_hosts:/etc/hosts
    networks:
      dockernet:
        ipv4_address: 172.18.0.30

  mariadb:
    image: mariadb:11.8.5
    container_name: mariadb
    restart: unless-stopped
    volumes:
      - ./application/mariadb/conf:/etc/mysql/conf.d
      - ./application/mariadb/store:/var/lib/mysql
      - ./application/mariadb/backup:/backup
      - ./_configs/container_hosts:/etc/hosts
    environment:
      MARIADB_ROOT_PASSWORD: ${DEFAULT_PASSWORD}
    networks:
      dockernet:
        ipv4_address: 172.18.0.31
    ports:
      - 3306:3306

  postgres:
    image: postgres:15.15
    container_name: postgres
    restart: unless-stopped
    volumes:
      - ./application/postgres/store:/var/lib/postgresql/data
      - ./_configs/container_hosts:/etc/hosts
    environment:
      POSTGRES_USER: ${DEFAULT_USERNAME}
      POSTGRES_PASSWORD: ${DEFAULT_PASSWORD}
      POSTGRES_DB: testdb
    networks:
      dockernet:
        ipv4_address: 172.18.0.32
    ports:
      - 5432:5432

  #
  # Vector DB Services
  #

  milvusetcd:
    image: quay.io/coreos/etcd:v3.5.25
    container_name: milvus-etcd
    restart: unless-stopped
    volumes:
      - ./application/milvus/etcd:/etcd
      - ./_configs/container_hosts:/etc/hosts
    environment:
      ALLOW_NONE_AUTHENTICATION: yes
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: 1000
      ETCD_QUOTA_BACKEND_BYTES: 4294967296
      ETCD_SNAPSHOT_COUNT: 50000
    command: etcd -advertise-client-urls=http://etcd:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    networks:
      dockernet:
        ipv4_address: 172.18.0.40

  milvusminio:
    image: minio/minio:RELEASE.2024-12-18T13-15-44Z
    container_name: milvus-minio
    restart: unless-stopped
    volumes:
      - ./application/milvus/minio:/minio_data
      - ./_configs/container_hosts:/etc/hosts
    environment:
      MINIO_ACCESS_KEY: ${DEFAULT_USERNAME}
      MINIO_SECRET_KEY: ${DEFAULT_PASSWORD}
    command: minio server /minio_data --console-address ":9001"
    networks:
      dockernet:
        ipv4_address: 172.18.0.41

  milvusstandalone:
    image: milvusdb/milvus:v2.6.7
    container_name: milvus-standalone
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
    depends_on:
      - "milvusetcd"
      - "milvusminio"
    volumes:
      - ./application/milvus/standalone:/var/lib/milvus
      - ./_configs/container_hosts:/etc/hosts
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: ${DEFAULT_USERNAME}
      MINIO_SECRET_ACCESS_KEY: ${DEFAULT_PASSWORD}
      MQ_TYPE: woodpecker
    command: /tini -- milvus run standalone
    networks:
      dockernet:
        ipv4_address: 172.18.0.42
